<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="groupMapper">
<!-- 지도 옆에 목록에 뿌려질 그룹방 전체목록 list -->
<select id="listSelect"  resultType="map">
	select b.bang_no BANG_NO, b.bang_name BANG_NAME, b.bang_memo BANG_MEMO,
		   s.store_name STORE_NAME, s.store_addr STORE_ADDR, s.store_business STORE_BUSINESS,
   		   b.bang_topic BANG_TOPIC, s.store_keyword STORE_KEYWORD, 
   		   b.bang_gender BANG_GENDER, b.bang_age BANG_AGE, b.bang_money BANG_MONEY, 
   		   b.bang_date BANG_DATE, b.bang_time BANG_TIME,
   		   b.bang_limit_people BANG_LIMIT_PEOPLE, b.bang_cur_people BANG_CUR_PEOPLE,
	       s.store_latitude STORE_LATITUDE, s.store_longitude STORE_LONGITUDE,
	       s.store_no STORE_NO, s.store_img STORE_IMG
	from   bang b, store s
	where  b.store_no = s.store_no
	order by b.bang_no desc
</select>
	
<!-- 모임방 검색시 검색어-string value 받음 -->
<select id="searchSelect" parameterType="string" resultType="map">	
	select b.bang_no BANG_NO, b.bang_name BANG_NAME, b.bang_memo BANG_MEMO,
		   s.store_name STORE_NAME, s.store_addr STORE_ADDR, s.store_business STORE_BUSINESS,
	       b.bang_topic BANG_TOPIC, s.store_keyword STORE_KEYWORD, 
	       b.bang_gender BANG_GENDER, b.bang_age BANG_AGE, b.bang_money BANG_MONEY, 
	       b.bang_date BANG_DATE, b.bang_time BANG_TIME,
	       b.bang_limit_people BANG_LIMIT_PEOPLE, b.bang_cur_people BANG_CUR_PEOPLE
	from   bang b, store s
	<where>  
		b.store_no = s.store_no
		<if test='value != null'>
			and (store_addr like '%'||#{value}||'%'
			 or  bang_name like '%'||#{value}||'%'
			 or  bang_memo like '%'||#{value}||'%'
			 or  store_keyword like '%'||#{value}||'%'
			 or  store_business like '%'||#{value}||'%')
		</if>
   </where>
</select>

<!-- 지도 위 분류 필터에 따른 검색 - 다중체크시 모든 key값과 :keyword 값을 받음 프로코콜값 -->
<select id="filterSelect" parameterType="map" resultType="map">	
	select b.bang_no BANG_NO, b.bang_name BANG_NAME, b.bang_memo BANG_MEMO,
		   s.store_name STORE_NAME, s.store_addr STORE_ADDR, s.store_business STORE_BUSINESS,
	       b.bang_topic BANG_TOPIC, s.store_keyword STORE_KEYWORD, 
	       b.bang_gender BANG_GENDER, b.bang_age BANG_AGE, b.bang_money BANG_MONEY, 
	       b.bang_date BANG_DATE, b.bang_time BANG_TIME,
	       b.bang_limit_people BANG_LIMIT_PEOPLE, b.bang_cur_people BANG_CUR_PEOPLE,
	       s.store_latitude STORE_LATITUDE, s.store_longitude STORE_LONGITUDE,
	       s.store_no STORE_NO, s.store_img STORE_IMG
	from   bang b, store s
	<where>
		   b.store_no = s.store_no        
	 	<if test='bang_topic!=null and bang_topic!=0'>
	    	AND b.bang_topic LIKE '%'||#{bang_topic}||'%'
	 	</if>		
	 	<if test='bang_gender!=null and bang_gender!=0'>
	    	AND b.bang_gender LIKE '%'||#{bang_gender}||'%'
	 	</if>		
	 	<if test='bang_age!=null and bang_age!=0'>
	    	AND b.bang_age LIKE '%'||#{bang_age}||'%'
	 	</if>	
	 	<if test='bang_money!=null and bang_money!=0'>
	    	AND b.bang_money LIKE '%'||#{bang_money}||'%'
	 	</if>	
	 	<if test='bang_limit_people!=null and bang_limit_people!=0'>
	    	AND b.bang_limit_people LIKE '%'||#{bang_limit_people}||'%'
	 	</if>	
	 	<if test='store_business!=null and bang_business!=0'>
	    	AND s.store_business LIKE '%'||#{store_business}||'%'
	 	</if>	
 	</where>
</select>

<!-- 지도 옆 목록에서 방 선택시 store_no, bang_no 받음 -->
<select id="groupSelect" parameterType="map" resultType="map">   
   select b.bang_id BANG_ID, b.bang_no BANG_NO, s.store_no STORE_NO, b.bang_name BANG_NAME, b.bang_memo BANG_MEMO,
           s.store_latitude STORE_LATITUDE, s.store_longitude STROE_LONGITUDE,    
           s.store_name STORE_NAME, s.store_addr STORE_ADDR, s.store_score STORE_SCORE, s.store_img STORE_IMG,
           decode(s.STORE_BUSINESS, (select GPROTOCOL from gubunja where gprotocol=s.STORE_BUSINESS), (select GSTRING from gubunja where gprotocol=s.STORE_BUSINESS)) STORE_BUSINESS,
           decode(b.BANG_TOPIC, (select GPROTOCOL from gubunja where gprotocol=b.BANG_TOPIC), (select GSTRING from gubunja where gprotocol=b.BANG_TOPIC)) BANG_TOPIC,
           s.store_keyword STORE_KEYWORD,
           decode(b.BANG_GENDER, (select GPROTOCOL from gubunja where gprotocol=b.BANG_GENDER), (select GSTRING from gubunja where gprotocol=b.BANG_GENDER)) BANG_GENDER, 
           decode(b.BANG_AGE, (select GPROTOCOL from gubunja where gprotocol=b.BANG_AGE), (select GSTRING from gubunja where gprotocol=b.BANG_AGE)) BANG_AGE,          
           b.bang_money BANG_MONEY, b.bang_date BANG_DATE,
           decode(b.BANG_TIME, (select GPROTOCOL from gubunja where gprotocol=b.BANG_TIME), (select GSTRING from gubunja where gprotocol=b.BANG_TIME)) BANG_TIME,
           b.bang_limit_people BANG_LIMIT_PEOPLE, b.bang_cur_people BANG_CUR_PEOPLE,
           m.mem_img MEM_IMG
    from   bang b, members m, store s
    where  b.store_no = s.store_no
    and    b.bang_no = #{bang_no}
    and    b.bang_id = m.mem_id
</select>

<!-- 방 선택후 친구목록보기 버튼 클릭시 보여줄 친구내용 -->
<select id="friendSelect" parameterType="string" resultType="map">
   select *
   from   bang_info b, members m
   where  b.bang_no = #{bang_no}
   and b.mem_id = m.mem_id   
</select>

<!-- 모임방 개설생성 버튼 누를시 input에 박은값들 다 받음 -->
<insert id="groupInsert" parameterType="map">
	insert into bang
	values(seq_bang_no.nextval, #{mem_id}, #{bang_name}, #{bang_limit_people}, 1,
		   #{bang_memo}, #{bang_money}, #{store_no}, #{bang_age}, #{bang_topic}, #{bang_time}, #{bang_date}, #{bang_gender})
</insert>

<!-- 방등록시 주소등록 누를시 가게 주소정보 -->
<select id="storeSelect" parameterType="map" resultType="map">
	select * 
	from store
	<where>
		rownum <![CDATA[<= 2000 ]]>
		<if test='value != null'>
			or store_addr LIKE '%'||#{value}||'%'
			or store_name LIKE '%'||#{value}||'%'
			or store_keyword LIKE '%'||#{value}||'%'
		</if>
	</where>
</select>

<!-- 모임 참석버튼 누를시 info에 인서트 -->
<select id="groupAttend" parameterType="map" statementType="CALLABLE">
	{ call proc_bang_attend(
		#{bang_no, mode=IN, jdbcType=VARCHAR, javaType=java.lang.String},
		#{mem_id, mode=IN,  jdbcType=VARCHAR, javaType=java.lang.String},
		#{mem_memo, mode=IN,  jdbcType=VARCHAR, javaType=java.lang.String},
		#{result, mode=OUT, jdbcType=NUMERIC, javaType=int}
	)}	
</select>	

<!-- 모임 취소버튼 누를시 info에 델리트 -->
<delete id="groupAbsent" parameterType="string">
	delete from bang_info
	where mem_id = #{mem_id}
	and bang_no = #{bang_no}
</delete>

<!-- 모임방 삭제버튼(방장만) -->
<select id="groupDelete" parameterType="map" statementType="CALLABLE">
	{ call proc_bang_delete(
		#{bang_no, mode=IN, jdbcType=VARCHAR, javaType=java.lang.String},
		#{result, mode=OUT, jdbcType=NUMERIC, javaType=int}
	)}	
</select>	
<!-- <delete id="groupDelete" parameterType="string">
	delete from bang
	where bang_no = #{bang_no}
</delete> -->

<!-- 모임방 수정(뱡장) 가게수정은 불가 방폭파후 다시생성 -->
<update id="groupUpdate" parameterType="map">
	update bang
	set
		bang_name  = #{bang_name}, 
		bang_memo  = #{bang_memo},
		bang_money = #{bang_money},
		bang_age   = #{bang_age},
		bang_topic = #{bang_topic},
		bang_date  = #{bang_date},
		bang_time  = #{bang_time},
		bang_gender   = #{bang_gender},
		bang_limit_people = #{bang_limit_people}
	where bang_id = #{bang_id}
</update>
</mapper>